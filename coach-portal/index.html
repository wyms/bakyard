<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bakyard Coach Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0a0c0f;
    --surface: #111318;
    --surface2: #1a1d24;
    --border: #252830;
    --accent: #c8f135;
    --accent2: #35f1c8;
    --text: #e8eaf0;
    --muted: #5a5e6a;
    --danger: #f13555;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
  #loginScreen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: radial-gradient(ellipse 80% 60% at 50% 0%, #1a2a0a 0%, var(--bg) 70%);
    position: relative;
  }
  #loginScreen::before {
    content: '';
    position: absolute;
    inset: 0;
    background-image: repeating-linear-gradient(0deg, transparent, transparent 39px, var(--border) 39px, var(--border) 40px),
                      repeating-linear-gradient(90deg, transparent, transparent 39px, var(--border) 39px, var(--border) 40px);
    opacity: 0.3;
    pointer-events: none;
  }

  .login-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 48px 40px;
    width: 380px;
    position: relative;
    box-shadow: 0 0 60px rgba(200,241,53,0.06), 0 24px 48px rgba(0,0,0,0.5);
  }
  .login-card::before {
    content: '';
    position: absolute;
    top: -1px; left: 10%; right: 10%;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }

  .logo-mark {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 42px;
    letter-spacing: 2px;
    color: var(--accent);
    line-height: 1;
    margin-bottom: 4px;
  }
  .logo-sub {
    font-size: 11px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 36px;
  }

  .field-label {
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    display: block;
    margin-bottom: 8px;
  }
  .field-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
    margin-bottom: 20px;
  }
  .field-input:focus { border-color: var(--accent); }

  .btn-primary {
    width: 100%;
    background: var(--accent);
    color: #0a0c0f;
    border: none;
    border-radius: 8px;
    padding: 14px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(200,241,53,0.25); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  .login-error {
    color: var(--danger);
    font-size: 12px;
    margin-top: 12px;
    text-align: center;
    min-height: 16px;
  }

  /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
  #app { display: none; min-height: 100vh; }

  .sidebar {
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: 220px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 100;
  }
  .sidebar-logo {
    padding: 24px 20px 20px;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-logo .logo-mark { font-size: 28px; margin-bottom: 0; }
  .sidebar-logo .logo-sub { margin-bottom: 0; font-size: 10px; }

  .sidebar-nav {
    flex: 1;
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: var(--muted);
    transition: all 0.15s;
    border: 1px solid transparent;
  }
  .nav-item:hover { color: var(--text); background: var(--surface2); }
  .nav-item.active { color: var(--accent); background: rgba(200,241,53,0.08); border-color: rgba(200,241,53,0.15); }
  .nav-icon { font-size: 16px; width: 20px; text-align: center; }
  .nav-badge {
    margin-left: auto;
    background: var(--danger);
    color: white;
    font-size: 10px;
    font-weight: 600;
    border-radius: 99px;
    padding: 1px 6px;
    min-width: 18px;
    text-align: center;
  }

  .sidebar-footer {
    padding: 16px 12px;
    border-top: 1px solid var(--border);
  }
  .coach-chip {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--surface2);
    border-radius: 8px;
    margin-bottom: 8px;
  }
  .coach-avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700; color: #0a0c0f;
    flex-shrink: 0;
  }
  .coach-name { font-size: 13px; font-weight: 600; }
  .coach-role { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
  .btn-logout {
    width: 100%;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px;
    color: var(--muted);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-logout:hover { border-color: var(--danger); color: var(--danger); }

  .main {
    margin-left: 220px;
    min-height: 100vh;
    padding: 32px;
  }

  .page { display: none; }
  .page.active { display: block; }

  .page-header { margin-bottom: 28px; }
  .page-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 2px;
    color: var(--text);
    line-height: 1;
  }
  .page-sub { color: var(--muted); font-size: 13px; margin-top: 4px; }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    position: relative;
    overflow: hidden;
  }
  .card-title {
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 16px;
  }

  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

  .stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    color: var(--accent);
    line-height: 1;
  }
  .stat-label { color: var(--muted); font-size: 12px; margin-top: 4px; }

  .price-display {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 64px;
    color: var(--accent);
    line-height: 1;
  }
  .price-unit { font-size: 18px; color: var(--muted); margin-left: 4px; }
  .price-row {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: 16px;
  }
  .field-input-inline {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 16px;
    width: 120px;
    outline: none;
    transition: border-color 0.2s;
  }
  .field-input-inline:focus { border-color: var(--accent); }
  .btn-save {
    background: var(--accent);
    color: #0a0c0f;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-save:hover { box-shadow: 0 4px 16px rgba(200,241,53,0.3); }
  .save-msg { font-size: 12px; color: var(--accent); opacity: 0; transition: opacity 0.3s; margin-left: 8px; }
  .save-msg.show { opacity: 1; }

  .session-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .date-display {
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    color: var(--accent2);
  }

  .student-list { display: flex; flex-direction: column; gap: 8px; }
  .student-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--surface2);
    border-radius: 8px;
    border: 1px solid transparent;
    transition: all 0.15s;
  }
  .student-row.present { border-color: rgba(200,241,53,0.2); background: rgba(200,241,53,0.05); }
  .student-row.absent { opacity: 0.5; }

  .student-check {
    width: 20px; height: 20px;
    border-radius: 5px;
    border: 2px solid var(--border);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .student-check.checked { background: var(--accent); border-color: var(--accent); color: #0a0c0f; }
  .student-name-text { flex: 1; font-size: 14px; }
  .student-time { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); }

  .add-student-row {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }
  .add-student-row .field-input { margin-bottom: 0; flex: 1; }
  .btn-add {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    color: var(--text);
    cursor: pointer;
    font-size: 13px;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .btn-add:hover { border-color: var(--accent); color: var(--accent); }

  .notes-area {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    line-height: 1.7;
    resize: vertical;
    min-height: 200px;
    outline: none;
    transition: border-color 0.2s;
  }
  .notes-area:focus { border-color: var(--accent2); }
  .notes-meta {
    font-size: 11px;
    color: var(--muted);
    margin-top: 8px;
    font-family: 'DM Mono', monospace;
  }

  .chat-container {
    display: flex;
    flex-direction: column;
    height: 500px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .chat-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .online-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 8px var(--accent);
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  .chat-title { font-weight: 600; font-size: 14px; }
  .online-count { font-size: 12px; color: var(--muted); margin-left: auto; }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    scroll-behavior: smooth;
  }
  .chat-messages::-webkit-scrollbar { width: 4px; }
  .chat-messages::-webkit-scrollbar-track { background: transparent; }
  .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .msg {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    animation: msgIn 0.2s ease;
  }
  @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .msg.mine { flex-direction: row-reverse; }
  .msg-avatar {
    width: 28px; height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: #0a0c0f;
    flex-shrink: 0;
  }
  .msg-bubble {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 14px;
    max-width: 60%;
  }
  .msg.mine .msg-bubble { background: rgba(200,241,53,0.1); border-color: rgba(200,241,53,0.2); }
  .msg-author { font-size: 10px; color: var(--muted); margin-bottom: 3px; letter-spacing: 1px; text-transform: uppercase; }
  .msg-text { font-size: 13px; line-height: 1.5; }
  .msg-time { font-size: 10px; color: var(--muted); margin-top: 3px; font-family: 'DM Mono', monospace; }

  .chat-input-row {
    display: flex;
    gap: 8px;
    padding: 16px 20px;
    border-top: 1px solid var(--border);
  }
  .chat-input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
  }
  .chat-input:focus { border-color: var(--accent2); }
  .btn-send {
    background: var(--accent2);
    color: #0a0c0f;
    border: none;
    border-radius: 8px;
    padding: 10px 16px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-send:hover { box-shadow: 0 4px 16px rgba(53,241,200,0.3); }

  .coaches-online { display: flex; flex-direction: column; gap: 8px; }
  .coach-online-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: var(--surface2);
    border-radius: 8px;
  }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .status-dot.online { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
  .status-dot.offline { background: var(--muted); }

  .quick-actions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }
  .qa-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  .qa-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(200,241,53,0.1); }
  .qa-icon { font-size: 28px; margin-bottom: 8px; }
  .qa-label { font-size: 12px; font-weight: 600; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }

  .tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 99px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .tag-green { background: rgba(200,241,53,0.15); color: var(--accent); border: 1px solid rgba(200,241,53,0.2); }
  .tag-cyan { background: rgba(53,241,200,0.15); color: var(--accent2); border: 1px solid rgba(53,241,200,0.2); }
  .tag-red { background: rgba(241,53,85,0.15); color: var(--danger); border: 1px solid rgba(241,53,85,0.2); }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  @media (max-width: 900px) {
    .sidebar { width: 64px; }
    .sidebar .logo-sub, .sidebar .coach-name, .sidebar .coach-role,
    .nav-item span:not(.nav-icon), .btn-logout { display: none; }
    .main { margin-left: 64px; }
    .grid-3 { grid-template-columns: 1fr; }
    .grid-2 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <div class="logo-mark">BAKYARD</div>
    <div class="logo-sub">Internal Coach Portal</div>
    <label class="field-label">Email</label>
    <input class="field-input" id="loginEmail" type="email" placeholder="coach@bakyard.com" autocomplete="email">
    <label class="field-label">Password</label>
    <input class="field-input" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="btn-primary" id="loginBtn" onclick="doLogin()">ACCESS PORTAL</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <nav class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-mark">BYD</div>
      <div class="logo-sub">Coach Portal</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-item active" onclick="showPage('dashboard')" id="nav-dashboard">
        <span class="nav-icon">‚ö°</span><span>Dashboard</span>
      </div>
      <div class="nav-item" onclick="showPage('pricing')" id="nav-pricing">
        <span class="nav-icon">üí∞</span><span>My Pricing</span>
      </div>
      <div class="nav-item" onclick="showPage('attendance')" id="nav-attendance">
        <span class="nav-icon">üìã</span><span>Attendance</span>
      </div>
      <div class="nav-item" onclick="showPage('notes')" id="nav-notes">
        <span class="nav-icon">üìù</span><span>Daily Notes</span>
      </div>
      <div class="nav-item" onclick="showPage('chat')" id="nav-chat">
        <span class="nav-icon">üí¨</span><span>Group Chat</span>
        <span class="nav-badge" id="chatBadge" style="display:none">‚Ä¢</span>
      </div>
    </div>
    <div class="sidebar-footer">
      <div class="coach-chip">
        <div class="coach-avatar" id="sidebarAvatar">?</div>
        <div>
          <div class="coach-name" id="sidebarName">‚Äì</div>
          <div class="coach-role">Coach</div>
        </div>
      </div>
      <button class="btn-logout" onclick="doLogout()">‚Ü© Sign Out</button>
    </div>
  </nav>

  <main class="main">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <div class="page-title">DASHBOARD</div>
        <div class="page-sub" id="dashGreet">Welcome back</div>
      </div>
      <div class="quick-actions">
        <div class="qa-card" onclick="showPage('pricing')">
          <div class="qa-icon">üí∞</div>
          <div class="qa-label">Update Pricing</div>
        </div>
        <div class="qa-card" onclick="showPage('attendance')">
          <div class="qa-icon">üìã</div>
          <div class="qa-label">Log Attendance</div>
        </div>
        <div class="qa-card" onclick="showPage('notes')">
          <div class="qa-icon">üìù</div>
          <div class="qa-label">Daily Notes</div>
        </div>
      </div>
      <div class="grid-3" style="margin-bottom:16px;">
        <div class="card">
          <div class="stat-value" id="dashRate">$‚Äì</div>
          <div class="stat-label">Private Lesson Rate / hr</div>
        </div>
        <div class="card">
          <div class="stat-value" id="dashToday">0</div>
          <div class="stat-label">Students Today</div>
        </div>
        <div class="card">
          <div class="stat-value" id="dashMessages">0</div>
          <div class="stat-label">Chat Messages Today</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Today's Session Snapshot</div>
        <div id="dashSnapshot" style="color:var(--muted); font-size:13px;">No students logged yet for today.</div>
      </div>
    </div>

    <!-- PRICING -->
    <div class="page" id="page-pricing">
      <div class="page-header">
        <div class="page-title">MY PRICING</div>
        <div class="page-sub">Set your lesson rates ‚Äî visible to students booking you</div>
      </div>
      <div class="grid-2">
        <div class="card">
          <div class="card-title">Private Lesson Rate</div>
          <div class="price-display" id="privateDisplay">$‚Äì<span class="price-unit">/hr</span></div>
          <div class="price-row">
            <input class="field-input-inline" id="privateInput" type="number" placeholder="85" min="0" max="999">
            <button class="btn-save" onclick="saveRate('private')">Save</button>
            <span class="save-msg" id="privateSaveMsg">‚úì Saved</span>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Group Session Rate</div>
          <div class="price-display" id="groupDisplay">$‚Äì<span class="price-unit">/hr</span></div>
          <div class="price-row">
            <input class="field-input-inline" id="groupInput" type="number" placeholder="45" min="0" max="999">
            <button class="btn-save" onclick="saveRate('group')">Save</button>
            <span class="save-msg" id="groupSaveMsg">‚úì Saved</span>
          </div>
        </div>
        <div class="card">
          <div class="card-title">10-Session Package</div>
          <div class="price-display" id="packageDisplay">$‚Äì<span class="price-unit">/pkg</span></div>
          <div class="price-row">
            <input class="field-input-inline" id="packageInput" type="number" placeholder="750" min="0" max="9999">
            <button class="btn-save" onclick="saveRate('package')">Save</button>
            <span class="save-msg" id="packageSaveMsg">‚úì Saved</span>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Drop-In Rate</div>
          <div class="price-display" id="dropinDisplay">$‚Äì<span class="price-unit">/visit</span></div>
          <div class="price-row">
            <input class="field-input-inline" id="dropinInput" type="number" placeholder="25" min="0" max="999">
            <button class="btn-save" onclick="saveRate('dropin')">Save</button>
            <span class="save-msg" id="dropinSaveMsg">‚úì Saved</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ATTENDANCE -->
    <div class="page" id="page-attendance">
      <div class="page-header">
        <div class="page-title">ATTENDANCE</div>
        <div class="page-sub">Track who showed up ‚Äî only you and fellow coaches can see this</div>
      </div>
      <div class="card" style="margin-bottom:16px;">
        <div class="session-header">
          <div>
            <div class="card-title" style="margin-bottom:4px;">Today's Session</div>
            <div class="date-display" id="attendanceDate">‚Äì</div>
          </div>
          <div style="text-align:right;">
            <div style="font-family:'Bebas Neue'; font-size:32px; color:var(--accent2);" id="presentCount">0</div>
            <div style="font-size:11px; color:var(--muted);">PRESENT</div>
          </div>
        </div>
        <div class="student-list" id="studentList"></div>
        <div class="add-student-row">
          <input class="field-input" id="newStudentName" placeholder="Add student name..." type="text"
            onkeydown="if(event.key==='Enter')addStudent()">
          <button class="btn-add" onclick="addStudent()">+ Add</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Session Notes (Private)</div>
        <textarea class="notes-area" id="sessionNote" placeholder="Add any notes about today's session..."></textarea>
        <div class="notes-meta" id="sessionNoteTime"></div>
        <div style="margin-top:12px;">
          <button class="btn-save" onclick="saveSessionNote()">Save Notes</button>
          <span class="save-msg" id="sessionNoteSaveMsg">‚úì Saved</span>
        </div>
      </div>
    </div>

    <!-- NOTES -->
    <div class="page" id="page-notes">
      <div class="page-header">
        <div class="page-title">DAILY NOTES</div>
        <div class="page-sub">Backend info, reminders, important updates ‚Äî coaches only</div>
      </div>
      <div class="card" style="margin-bottom:16px;">
        <div class="card-title">Today's Backend Notes</div>
        <textarea class="notes-area" id="dailyNotes"
          placeholder="Equipment checks, schedule changes, student follow-ups, facility notes...&#10;&#10;Example:&#10;- Court 2 net needs tightening&#10;- Jake moving to Thursday group&#10;- New student Maria starting Monday ‚Äî beginner level"></textarea>
        <div class="notes-meta" id="dailyNotesMeta"></div>
        <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
          <button class="btn-save" onclick="saveDailyNotes()">Save Notes</button>
          <span class="save-msg" id="dailySaveMsg">‚úì Saved</span>
        </div>
      </div>
      <div class="card">
        <div class="card-title">All Coaches' Notes Today</div>
        <div id="notesHistory" style="display:flex; flex-direction:column; gap:8px;"></div>
      </div>
    </div>

    <!-- CHAT -->
    <div class="page" id="page-chat">
      <div class="page-header">
        <div class="page-title">GROUP CHAT</div>
        <div class="page-sub">Internal coaches only ‚Äî real-time coordination</div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 200px; gap:16px; align-items:start;">
        <div class="chat-container">
          <div class="chat-header">
            <div class="online-dot"></div>
            <div class="chat-title">Bakyard Coaches</div>
            <div class="online-count" id="onlineCountLabel">‚Äì</div>
          </div>
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-row">
            <input class="chat-input" id="chatInput" placeholder="Message coaches..."
              type="text" onkeydown="if(event.key==='Enter')sendMessage()">
            <button class="btn-send" onclick="sendMessage()">Send</button>
          </div>
        </div>
        <div class="card" style="padding:16px;">
          <div class="card-title">Online Now</div>
          <div class="coaches-online" id="coachesOnlineList">
            <div style="color:var(--muted);font-size:13px;">Loading...</div>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
const SUPABASE_URL  = 'https://vujgrceogdfdzxwprqwj.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1amdyY2VvZ2RmZHp4d3BycXdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzODMzNjgsImV4cCI6MjA4Njk1OTM2OH0.kPkL8rv6tDVYcYWz0_VAZ3V0IVMxxUCne9U-21HGjeA';

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON);

const priceUnits = { private: '/hr', group: '/hr', package: '/pkg', dropin: '/visit' };

let state = {
  user: null,
  coachProfile: null,
  attendanceSessionId: null,
  chatSub: null,
};

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function nowTime() {
  return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
function todayDate() {
  return new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}
function todayISO() {
  return new Date().toISOString().slice(0, 10);
}
function initials(name) {
  return name.split(' ').map(p => p[0]).join('').toUpperCase().slice(0, 2);
}
function flashSave(id) {
  const el = document.getElementById(id);
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPass').value;
  const err   = document.getElementById('loginError');
  const btn   = document.getElementById('loginBtn');

  if (!email || !pass) { err.textContent = 'Enter your email and password.'; return; }

  btn.disabled = true;
  btn.textContent = 'Signing in‚Ä¶';
  err.textContent = '';

  const { data, error } = await db.auth.signInWithPassword({ email, password: pass });
  if (error) {
    err.textContent = error.message;
    btn.disabled = false;
    btn.textContent = 'ACCESS PORTAL';
    return;
  }

  // Check this user has a coach_profile
  const { data: profile } = await db
    .from('coach_profiles')
    .select('*, users(full_name, avatar_url)')
    .eq('user_id', data.user.id)
    .single();

  if (!profile) {
    err.textContent = 'No coach profile found for this account.';
    await db.auth.signOut();
    btn.disabled = false;
    btn.textContent = 'ACCESS PORTAL';
    return;
  }

  state.user = data.user;
  state.coachProfile = profile;
  enterApp();
}

async function doLogout() {
  if (state.chatSub) state.chatSub.unsubscribe();
  await db.auth.signOut();
  state = { user: null, coachProfile: null, attendanceSessionId: null, chatSub: null };
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPass').value = '';
  document.getElementById('loginBtn').disabled = false;
  document.getElementById('loginBtn').textContent = 'ACCESS PORTAL';
}

function enterApp() {
  const name = state.coachProfile.users?.full_name || state.user.email;
  document.getElementById('sidebarName').textContent = name.split(' ')[0] + (name.split(' ')[1] ? ' ' + name.split(' ')[1] : '');
  document.getElementById('sidebarAvatar').textContent = initials(name);
  document.getElementById('dashGreet').textContent = `Welcome back, ${name.split(' ')[0]} üëã`;
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';

  loadRates();
  loadAttendance();
  loadDailyNotes();
  loadChat();
  refreshDashboard();
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  document.getElementById('nav-' + id).classList.add('active');
  if (id === 'chat') document.getElementById('chatBadge').style.display = 'none';
  if (id === 'dashboard') refreshDashboard();
}

// ‚îÄ‚îÄ PRICING ‚îÄ‚îÄ
async function loadRates() {
  const { data } = await db
    .from('coach_rates')
    .select('rate_type, amount')
    .eq('coach_id', state.coachProfile.id);

  const defaults = { private: 85, group: 45, package: 750, dropin: 25 };
  const rates = { ...defaults };
  (data || []).forEach(r => { rates[r.rate_type] = r.amount; });

  Object.keys(rates).forEach(type => {
    document.getElementById(type + 'Display').innerHTML =
      `$${rates[type]}<span class="price-unit">${priceUnits[type]}</span>`;
  });

  document.getElementById('dashRate').textContent = `$${rates.private}`;
}

async function saveRate(type) {
  const val = parseInt(document.getElementById(type + 'Input').value);
  if (isNaN(val) || val < 0) return;

  await db.from('coach_rates').upsert({
    coach_id: state.coachProfile.id,
    rate_type: type,
    amount: val,
    updated_at: new Date().toISOString(),
  }, { onConflict: 'coach_id,rate_type' });

  document.getElementById(type + 'Display').innerHTML =
    `$${val}<span class="price-unit">${priceUnits[type]}</span>`;
  document.getElementById(type + 'Input').value = '';
  flashSave(type + 'SaveMsg');

  if (type === 'private') document.getElementById('dashRate').textContent = `$${val}`;
}

// ‚îÄ‚îÄ ATTENDANCE ‚îÄ‚îÄ
async function loadAttendance() {
  document.getElementById('attendanceDate').textContent = todayDate();

  // Get or create today's attendance session
  let { data: session } = await db
    .from('attendance_sessions')
    .select('id, notes')
    .eq('coach_id', state.coachProfile.id)
    .eq('session_date', todayISO())
    .single();

  if (!session) {
    const { data: newSession } = await db
      .from('attendance_sessions')
      .insert({ coach_id: state.coachProfile.id, session_date: todayISO() })
      .select('id, notes')
      .single();
    session = newSession;
  }

  state.attendanceSessionId = session?.id;

  if (session?.notes) {
    document.getElementById('sessionNote').value = session.notes;
    document.getElementById('sessionNoteTime').textContent = `Saved`;
  }

  await renderStudents();
}

async function renderStudents() {
  if (!state.attendanceSessionId) return;

  const { data: records } = await db
    .from('attendance_records')
    .select('id, student_name, present')
    .eq('attendance_session_id', state.attendanceSessionId)
    .order('added_at');

  const list = document.getElementById('studentList');
  list.innerHTML = '';
  let presentCount = 0;

  (records || []).forEach(r => {
    if (r.present) presentCount++;
    const row = document.createElement('div');
    row.className = 'student-row' + (r.present ? ' present' : ' absent');
    row.innerHTML = `
      <div class="student-check ${r.present ? 'checked' : ''}" onclick="togglePresent('${r.id}', ${!r.present})">${r.present ? '‚úì' : ''}</div>
      <div class="student-name-text">${r.student_name}</div>
      <div class="student-time">${r.present ? '‚úì Present' : '‚úó Absent'}</div>
      <div style="cursor:pointer;color:var(--muted);font-size:11px;margin-left:8px;" onclick="removeStudent('${r.id}')">‚úï</div>
    `;
    list.appendChild(row);
  });

  document.getElementById('presentCount').textContent = presentCount;
  refreshDashboard();
}

async function togglePresent(recordId, present) {
  await db.from('attendance_records').update({ present }).eq('id', recordId);
  await renderStudents();
}

async function addStudent() {
  const inp = document.getElementById('newStudentName');
  const name = inp.value.trim();
  if (!name || !state.attendanceSessionId) return;

  await db.from('attendance_records').insert({
    attendance_session_id: state.attendanceSessionId,
    student_name: name,
    present: false,
  });
  inp.value = '';
  await renderStudents();
}

async function removeStudent(recordId) {
  await db.from('attendance_records').delete().eq('id', recordId);
  await renderStudents();
}

async function saveSessionNote() {
  if (!state.attendanceSessionId) return;
  const text = document.getElementById('sessionNote').value;
  await db.from('attendance_sessions')
    .update({ notes: text, updated_at: new Date().toISOString() })
    .eq('id', state.attendanceSessionId);
  document.getElementById('sessionNoteTime').textContent = `Last saved ${nowTime()}`;
  flashSave('sessionNoteSaveMsg');
}

// ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ
async function loadDailyNotes() {
  const { data: myNote } = await db
    .from('coach_notes')
    .select('content, updated_at')
    .eq('coach_id', state.coachProfile.id)
    .eq('note_date', todayISO())
    .single();

  if (myNote) {
    document.getElementById('dailyNotes').value = myNote.content;
    document.getElementById('dailyNotesMeta').textContent =
      `Last saved ${new Date(myNote.updated_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
  }

  await renderNotesHistory();
}

async function saveDailyNotes() {
  const text = document.getElementById('dailyNotes').value;
  await db.from('coach_notes').upsert({
    coach_id: state.coachProfile.id,
    note_date: todayISO(),
    content: text,
    updated_at: new Date().toISOString(),
  }, { onConflict: 'coach_id,note_date' });

  document.getElementById('dailyNotesMeta').textContent =
    `Last saved ${nowTime()} by ${(state.coachProfile.users?.full_name || state.user.email).split(' ')[0]}`;
  flashSave('dailySaveMsg');
  await renderNotesHistory();
}

async function renderNotesHistory() {
  const el = document.getElementById('notesHistory');

  const { data: notes } = await db
    .from('coach_notes')
    .select('content, updated_at, coach_id, coach_profiles!inner(users(full_name))')
    .eq('note_date', todayISO())
    .order('updated_at', { ascending: false });

  if (!notes || !notes.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:13px;">No notes yet today.</div>';
    return;
  }

  el.innerHTML = notes.map(n => {
    const author = n.coach_profiles?.users?.full_name || 'Coach';
    const time   = new Date(n.updated_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const preview = n.content.substring(0, 120) + (n.content.length > 120 ? '‚Ä¶' : '');
    return `
      <div style="padding:12px 16px; background:var(--surface2); border-radius:8px; border:1px solid var(--border);">
        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
          <span class="tag tag-cyan">${author}</span>
          <span style="font-size:11px; color:var(--muted); font-family:'DM Mono',monospace;">${time}</span>
        </div>
        <div style="font-size:13px; color:var(--text); line-height:1.5; white-space:pre-wrap;">${preview}</div>
      </div>
    `;
  }).join('');
}

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ
async function loadChat() {
  await renderChat();

  // Real-time subscription
  state.chatSub = db
    .channel('coach_messages')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'coach_messages' }, async () => {
      await renderChat();
      // Badge if not on chat tab
      if (!document.getElementById('page-chat').classList.contains('active')) {
        document.getElementById('chatBadge').style.display = '';
      }
    })
    .subscribe();
}

async function renderChat() {
  const { data: messages } = await db
    .from('coach_messages')
    .select('id, content, created_at, coach_id, coach_profiles!inner(users(full_name))')
    .order('created_at', { ascending: true })
    .limit(100);

  const el = document.getElementById('chatMessages');
  el.innerHTML = (messages || []).map(m => {
    const author = m.coach_profiles?.users?.full_name || 'Coach';
    const mine   = m.coach_id === state.coachProfile.id;
    const time   = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    return `
      <div class="msg ${mine ? 'mine' : ''}">
        <div class="msg-avatar">${initials(author)}</div>
        <div>
          ${!mine ? `<div class="msg-author">${author}</div>` : ''}
          <div class="msg-bubble"><div class="msg-text">${escapeHtml(m.content)}</div></div>
          <div class="msg-time">${time}</div>
        </div>
      </div>
    `;
  }).join('');
  el.scrollTop = el.scrollHeight;

  // Today's message count for dashboard
  const today = messages?.filter(m => m.created_at.startsWith(todayISO())) || [];
  document.getElementById('dashMessages').textContent = today.length;
}

async function sendMessage() {
  const inp  = document.getElementById('chatInput');
  const text = inp.value.trim();
  if (!text) return;

  inp.value = '';
  await db.from('coach_messages').insert({
    coach_id: state.coachProfile.id,
    content: text,
  });
  // renderChat will be triggered by realtime subscription
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
async function refreshDashboard() {
  if (!state.attendanceSessionId) return;

  const { data: records } = await db
    .from('attendance_records')
    .select('present, student_name')
    .eq('attendance_session_id', state.attendanceSessionId);

  const present = (records || []).filter(r => r.present);
  const absent  = (records || []).filter(r => !r.present);

  document.getElementById('dashToday').textContent = present.length;

  const snap = document.getElementById('dashSnapshot');
  if (!records || !records.length) {
    snap.textContent = 'No students logged yet for today.';
    return;
  }

  snap.innerHTML = `
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
      ${present.map(r => `<span class="tag tag-green">‚úì ${r.student_name}</span>`).join('')}
      ${absent.map(r => `<span class="tag tag-red">‚úó ${r.student_name}</span>`).join('')}
    </div>
    <div style="font-size:12px;color:var(--muted);">${present.length} / ${records.length} present today</div>
  `;
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ BOOT ‚Äî restore existing session ‚îÄ‚îÄ
db.auth.getSession().then(async ({ data: { session } }) => {
  if (!session) return;

  const { data: profile } = await db
    .from('coach_profiles')
    .select('*, users(full_name, avatar_url)')
    .eq('user_id', session.user.id)
    .single();

  if (profile) {
    state.user = session.user;
    state.coachProfile = profile;
    enterApp();
  }
});
</script>
</body>
</html>
